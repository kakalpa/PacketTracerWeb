#!/bin/bash
set -euo pipefail

# Enhanced VNC startup with VirtualGL/OpenGL support for 3D rendering
# Supports both direct GL rendering (if GPU available) and Mesa indirect GL

VNC_PASS=${VNC_PASS:-Cisco123}
VNC_GEOMETRY=${VNC_GEOMETRY:-1280x720}
VNC_DEPTH=${VNC_DEPTH:-24}  # Use 24-bit for better GL rendering quality
VNC_PORT=${VNC_PORT:-5901}

rm -f /home/ptuser/.vnc/*.pid
rm -f /home/ptuser/.vnc/*.log
rm -Rf /tmp/.X*

# Setup VNC environment
mkdir -p /home/ptuser/.vnc
chown -R ptuser:ptuser /home/ptuser/.vnc

if [ ! -f /home/ptuser/.vnc/passwd ]; then
    if command -v /opt/TurboVNC/bin/vncpasswd &>/dev/null; then
        printf '%s\n' "$VNC_PASS" | /opt/TurboVNC/bin/vncpasswd -f > /home/ptuser/.vnc/passwd || true
    elif command -v vncpasswd &>/dev/null; then
        printf '%s\n' "$VNC_PASS" | vncpasswd -f > /home/ptuser/.vnc/passwd || true
    else
        echo "Warning: vncpasswd not found, VNC will have no password"
    fi
    chown ptuser:ptuser /home/ptuser/.vnc/passwd || true
    chmod 600 /home/ptuser/.vnc/passwd || true
fi

# Setup X authority
touch /home/ptuser/.Xauthority
chown ptuser:ptuser /home/ptuser/.Xauthority
chmod 600 /home/ptuser/.Xauthority

# Start Xvfb virtual display for better stability with x11vnc
echo "Starting Xvfb virtual display :1..."
Xvfb :1 -screen 0 ${VNC_GEOMETRY}x${VNC_DEPTH} -nolisten tcp -dpi 96 >/tmp/xvfb.log 2>&1 &
XVFB_PID=$!
sleep 2

if ! kill -0 $XVFB_PID 2>/dev/null; then
    echo "Xvfb failed to start" >&2
    cat /tmp/xvfb.log
    exit 1
fi
echo "✓ Xvfb started (PID $XVFB_PID)"

# Start XFCE desktop on the virtual display
echo "Starting XFCE desktop..."
DISPLAY=:1 XAUTHORITY=/home/ptuser/.Xauthority su - ptuser -c "startxfce4" >/tmp/xfce.log 2>&1 &
XFCE_PID=$!
sleep 5
echo "✓ XFCE desktop started (PID $XFCE_PID)"

# Start TurboVNC or x11vnc server
# TurboVNC is optimized for 3D rendering over network, fallback to x11vnc
# Try x11vnc first for better compatibility with guacamole
if command -v x11vnc &>/dev/null; then
    echo "Starting x11vnc VNC server on port ${VNC_PORT}..."
    x11vnc -display :1 \
      -geometry ${VNC_GEOMETRY} \
      -depth ${VNC_DEPTH} \
      -rfbport ${VNC_PORT} \
      -nolisten tcp \
      -noshm \
      -threads \
      -forever \
      -bg \
      -logfile /tmp/x11vnc.log || {
        echo "x11vnc failed, trying TurboVNC..."
        if command -v /opt/TurboVNC/bin/vncserver &>/dev/null; then
            echo "Starting TurboVNC server on port ${VNC_PORT}..."
            DISPLAY=:1 /opt/TurboVNC/bin/vncserver \
              -geometry ${VNC_GEOMETRY} \
              -depth ${VNC_DEPTH} \
              -rfbport ${VNC_PORT} \
              -securitytypes none \
              >/tmp/turbovnc.log 2>&1
        fi
    }
    sleep 2
    echo "✓ VNC server started on port ${VNC_PORT}"
else
    echo "Starting TurboVNC server on port ${VNC_PORT}..."
    DISPLAY=:1 /opt/TurboVNC/bin/vncserver \
      -geometry ${VNC_GEOMETRY} \
      -depth ${VNC_DEPTH} \
      -rfbport ${VNC_PORT} \
      -securitytypes none \
      >/tmp/turbovnc.log 2>&1
    sleep 2
    echo "✓ TurboVNC server started on port ${VNC_PORT}"
fi

# Launch PacketTracer with VirtualGL if available
# PacketTracer binary will be injected at runtime via /opt/pt mount
# Launch within the TurboVNC session using DISPLAY=:2
sleep 10  # Give desktop time to fully start and stabilize

# Check if PacketTracer binary exists
if [ ! -f /opt/pt/squashfs-root/AppRun ]; then
    echo "PacketTracer binary not found - it will be injected at runtime"
    echo "Container will keep running with VNC + Desktop ready for manual launch"
else
    if command -v vglrun &>/dev/null; then
        echo "Launching PacketTracer with GPU-accelerated rendering (VirtualGL)..."
        export DISPLAY=:2
        export XAUTHORITY=/home/ptuser/.Xauthority
        su - ptuser <<'EOF' >/tmp/packettracer.log 2>&1 &
export DISPLAY=:2
export XAUTHORITY=/home/ptuser/.Xauthority
vglrun /opt/pt/squashfs-root/AppRun
EOF
        echo "✓ PacketTracer launched with VirtualGL"
    else
        echo "Launching PacketTracer with Mesa indirect GL rendering..."
        export DISPLAY=:2
        export XAUTHORITY=/home/ptuser/.Xauthority
        export LIBGL_ALWAYS_INDIRECT=1
        export LIBGL_INDIRECT_DISPATCH=1
        export GALLIUM_DRIVER=llvmpipe
        export MESA_GL_VERSION_OVERRIDE=4.6
        su - ptuser <<'EOF' >/tmp/packettracer.log 2>&1 &
export DISPLAY=:2
export XAUTHORITY=/home/ptuser/.Xauthority
export LIBGL_ALWAYS_INDIRECT=1
export LIBGL_INDIRECT_DISPATCH=1
export GALLIUM_DRIVER=llvmpipe
export MESA_GL_VERSION_OVERRIDE=4.6
/opt/pt/squashfs-root/AppRun
EOF
        echo "✓ PacketTracer launched with Mesa rendering"
    fi
fi

echo ""
echo "=== VNC + GPU-Accelerated Rendering Ready ==="
echo "✓ TurboVNC VNC server running on port ${VNC_PORT}"
echo "✓ Display: :2 (1280x720x24)"
echo "✓ GPU Rendering: vglrun available"
echo "✓ Connect via VNC to port ${VNC_PORT} to access desktop and 3D models"
echo ""

# Keep container alive
while true; do sleep 3600; done
