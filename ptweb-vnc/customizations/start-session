#!/bin/bash
set -euo pipefail

# Configure VNC runtime settings
# VNC_GEOMETRY: 1280x720, 1024x768, 1920x1080 (default: 1280x720)
# VNC_DEPTH: 8, 16, 24 (default: 16 for low bandwidth)
VNC_PASS=${VNC_PASS:-Cisco123}
VNC_GEOMETRY=${VNC_GEOMETRY:-1280x720}
VNC_DEPTH=${VNC_DEPTH:-16}

rm -f /home/ptuser/.vnc/*.pid
rm -f /home/ptuser/.vnc/*.log
rm -Rf /tmp/.X*

# Setup VNC environment for ptuser
mkdir -p /home/ptuser/.vnc
chown -R ptuser:ptuser /home/ptuser/.vnc

if [ ! -f /home/ptuser/.vnc/passwd ]; then
    printf '%s\n' "$VNC_PASS" | vncpasswd -f > /home/ptuser/.vnc/passwd || true
    chown ptuser:ptuser /home/ptuser/.vnc/passwd || true
    chmod 600 /home/ptuser/.vnc/passwd || true
fi

# Setup X authority
touch /home/ptuser/.Xauthority
chown ptuser:ptuser /home/ptuser/.Xauthority
chmod 600 /home/ptuser/.Xauthority

# Start VNC server with configurable geometry and depth
# Lower depth saves memory and bandwidth
echo "Starting VNC server on display :1 (port 5901)..."
/usr/bin/vncserver -geometry "${VNC_GEOMETRY}" -depth "${VNC_DEPTH}" || {
    echo "vncserver failed to start" >&2
    exit 1
}

sleep 5

# Keep container alive
while true; do sleep 3600; done
