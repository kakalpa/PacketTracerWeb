# Enhanced Nginx configuration with HTTPS, security hardening, GeoIP, and auth
# Place certificates in ptweb-vnc/certs/ directory
# GeoIP: Requires MaxMind GeoIP2 database in ptweb-vnc/pt-nginx/conf/geoip-data/

# Load GeoIP module (if available)
# include /etc/nginx/modules-enabled/ngx_http_geoip2_module.conf;

# Include GeoIP allowed countries configuration (auto-generated by secure-setup.sh)
# include geoip-allowed.conf;

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=guac_login:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=guac_api:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=download:10m rate=50r/m;
limit_req_zone $binary_remote_addr zone=general:10m rate=100r/m;

# Upstream Guacamole connection
upstream guacamole_backend {
    server guacamole:8080;
    keepalive 32;
}

# HTTP redirect to HTTPS (comment out if not using HTTPS)
# server {
#     listen       80;
#     server_name  localhost;
#     return 301 https://$server_name$request_uri;
# }

# Main server configuration
server {
    # Listen on HTTP (comment out if using HTTPS)
    listen       80;
    # Or HTTPS (uncomment after enabling)
    # listen       443 ssl http2;
    # listen       [::]:443 ssl http2;

    server_name  localhost;

    # SSL Configuration (uncomment and update paths if using HTTPS)
    # ssl_certificate /etc/nginx/certs/fullchain.pem;
    # ssl_certificate_key /etc/nginx/certs/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    # ssl_prefer_server_ciphers on;
    # ssl_session_cache shared:SSL:10m;
    # ssl_session_timeout 10m;
    # ssl_stapling on;
    # ssl_stapling_verify on;

    charset utf-8;
    
    # Logging
    access_log /var/log/nginx/host.access.log main;
    error_log /var/log/nginx/host.error.log warn;

    # Security Headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Uncomment after enabling HTTPS:
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Disable server tokens to not reveal Nginx version
    server_tokens off;

    # ===== DOWNLOADS ENDPOINT =====
    # Highest priority (^~ = non-regex prefix match)
    location ^~ /downloads/ {
        alias /shared/;
        
        # Security: Rate limit downloads
        limit_req zone=download burst=10 nodelay;
        
        # GeoIP Blocking (uncomment if using MaxMind GeoIP2 database)
        # if ($country_allowed = 0) {
        #     return 403;
        # }
        
        # HTTP Basic Authentication (uncomment to require credentials)
        # auth_basic "Restricted Downloads";
        # auth_basic_user_file /etc/nginx/auth/.htpasswd;
        
        # List files
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # Prevent execution of scripts in shared folder
        location ~ /downloads/.*\.php$ {
            return 403;
        }
        location ~ /downloads/.*\.sh$ {
            return 403;
        }
        location ~ /downloads/.*\.exe$ {
            return 403;
        }
    }

    # ===== FILE MANAGER INTERFACE =====
    location ^~ /files {
        rewrite ^/files/?$ /file-manager.html break;
    }

    # ===== GUACAMOLE LOGIN =====
    location ~ ^/guacamole/api/tokens$ {
        # Rate limit login attempts (10 attempts per minute)
        limit_req zone=guac_login burst=5 nodelay;
        
        proxy_pass http://guacamole_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # ===== GUACAMOLE API =====
    location ~ ^/guacamole/api/ {
        # Rate limit API (100 requests per minute)
        limit_req zone=guac_api burst=20 nodelay;
        
        proxy_pass http://guacamole_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # ===== GUACAMOLE WEBSOCKET (TUNNEL) =====
    location /guacamole/tunnel {
        proxy_pass http://guacamole_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket specific settings
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_redirect off;
        
        # Buffer settings for WebSocket
        proxy_buffering off;
        proxy_buffer_size 0;
    }

    # ===== GUACAMOLE ROOT =====
    location / {
        # Rate limit general requests (100 requests per minute)
        limit_req zone=guac_api burst=20 nodelay;
        
        proxy_pass http://guacamole_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # Buffer settings
        client_max_body_size 10m;
        client_body_buffer_size 128k;
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffers 32 4k;
    }

    # ===== DENY DANGEROUS PATHS =====
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ===== ERROR PAGES =====
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
    
    error_page   401 403 404 =404 /404.html;
    location = /404.html {
        root   /usr/share/nginx/html;
    }

    # ===== DENY ACCESS TO SENSITIVE FILES =====
    location ~ \.env {
        deny all;
    }
    location ~ \.git {
        deny all;
    }
    location ~ docker-compose {
        deny all;
    }
}

# HTTPS Server Configuration (Uncomment after getting certificates)
# server {
#     listen       443 ssl http2;
#     listen       [::]:443 ssl http2;
#     server_name  your-domain.com;
#
#     ssl_certificate /etc/nginx/certs/fullchain.pem;
#     ssl_certificate_key /etc/nginx/certs/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#
#     # OCSP Stapling
#     ssl_stapling on;
#     ssl_stapling_verify on;
#     ssl_trusted_certificate /etc/nginx/certs/chain.pem;
#     resolver 8.8.8.8 8.8.4.4 valid=300s;
#
#     # ... rest of configuration same as above ...
# }
