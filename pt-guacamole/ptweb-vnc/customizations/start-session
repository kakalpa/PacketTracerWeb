#!/bin/bash
# start-session - start VNC and Packet Tracer session (patched for PT8 detection)
set -e

rm -f /home/ptuser/.vnc/*.pid
rm -f /home/ptuser/.vnc/*.log
rm -Rf /tmp/.X*
export HOME=/home/ptuser
export USER=ptuser

echo "Starting the VNC server ..."
# start vncserver on display :1 with a reasonable geometry
# original used /usr/bin/vncserver -geometry 1200x800
/usr/bin/vncserver :1 -geometry 1200x800 -depth 24

sleep 3

# Launch Packet Tracer inside Firejail as ptuser
# We expect Packet Tracer binary under /usr/local/bin/PacketTracer or /opt/pt/packettracer etc.
# Prefer to launch via full path if available; otherwise try common names.

PT_CMD=""
# Common installation paths - check them:
for p in /usr/bin/packettracer /usr/local/bin/packettracer /opt/pt/packettracer /usr/bin/PacketTracer /opt/pt/PacketTracer; do
    if [ -x "$p" ]; then
        PT_CMD="$p"
        break
    fi
done

# If PT_CMD still empty, try just "packettracer" in PATH
if [ -z "$PT_CMD" ]; then
    if command -v PacketTracer >/dev/null 2>&1; then
        PT_CMD="$(command -v PacketTracer)"
    elif command -v packettracer >/dev/null 2>&1; then
        PT_CMD="$(command -v packettracer)"
    fi
fi

if [ -z "$PT_CMD" ]; then
    echo "Packet Tracer binary not found. Attempting to continue (maybe installer set alternate name)."
fi

# Run Packet Tracer inside firejail (no network). If PT_CMD empty, run generic 'PacketTracer' command
if [ -n "$PT_CMD" ]; then
    echo "Launching Packet Tracer via firejail: $PT_CMD"
    # use --profile to lock down
    firejail --profile=/etc/firejail/packettracer.profile --quiet "$PT_CMD" &
else
    echo "Launching fallback: firejail PacketTracer"
    firejail --profile=/etc/firejail/packettracer.profile --quiet PacketTracer &
fi

sleep 5

# Now check whether Packet Tracer started (check for common process names)
PT_PID=""
# Try several variants
for name in PacketTracer packettracer PacketTracer7 PacketTracer8 packet-tracer; do
    PT_PID=$(pidof -s "$name" 2>/dev/null || true)
    if [ -n "$PT_PID" ]; then
        break
    fi
done

# if still not found, try pgrep
if [ -z "$PT_PID" ]; then
    PT_PID=$(pgrep -f "PacketTracer" || true)
fi

sleep 2

if [ -z "${PT_PID}" ]; then
    echo "Failed to start Packet Tracer (no process found)."
    # keep container alive for debugging (do not exit)
    tail -f /dev/null
else
    echo "Packet Tracer started (pid ${PT_PID})."
fi

# keep the container running
while true; do sleep 3600; done

